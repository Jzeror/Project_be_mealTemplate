<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.bemeal.web.taste.TasteMapper">
  		<resultMap type="hashmap" id="tmap">
  		<result property="itemSeq" column="ITEM_SEQ"/>
  		<result property="itemName" column="ITEM_NAME"/>
  		<result property="brand" column="BRAND"/>
  		<result property="category" column="CATEGORY"/>
  		<result property="price" column="PRICE"/>
  		<result property="salePercent" column="SALE_PERCENT"/>
  		<result property="event" column="EVENT"/>
  		<result property="newItem" column="NEW_ITEM"/>
  		<result property="explains" column="EXPLAINS"/>
  		<result property="calorie" column="CALORIE"/>
  		<result property="imgSeq" column="IMG_SEQ"/>
  		<result property="img" column="IMG"/>
  		<result property="memberId" column="MEMBER_ID"/>
  		<result property="tasteSeq" column="TASTE_SEQ"/>
  		<result property="quantity" column="QUANTITY"/>
  		<result property="dirName" column="DIR_NAME"/>
  		<result property="grade" column="GRADE"/>
  		<result property="tasteDate" column="TASTE_DATE"/>
  		<result property="tasteTime" column="TASTE_TIME"/>
  		<result property="flag" column="FLAG"/>
  	</resultMap>
  	<insert id="post">
  		INSERT INTO TASTE
  		(QUANTITY,DIR_NAME,GRADE,FLAG,MEMBER_ID,ITEM_SEQ)
  		VALUES
  		(#{quantity},#{dirName},#{grade},#{flag},#{memberId},#{itemSeq})
  	</insert>
 	<select id="chartArea" resultType="java.util.HashMap">
 	SELECT GRADE "grade", COUNT(GRADE) AS "cntgrade"
	FROM TASTE
	WHERE MEMBER_ID LIKE 'test1' AND FLAG LIKE 'star'
	GROUP BY GRADE;
 	</select>
	<select id="chartIngre" resultType="java.util.HashMap">
 	SELECT * 
FROM (SELECT G.TAG_NAME AS "ingre", AVG(T.GRADE) AS "ingreAvg", COUNT(T.GRADE) AS "ingreCnt" 
	FROM ITEM I, TASTE T, TAG_ITEM A, TAG G
	WHERE I.ITEM_SEQ = T.ITEM_SEQ
	AND I.ITEM_SEQ = A.ITEM_SEQ
	AND A.TAG_SEQ = G.TAG_SEQ
	AND T.MEMBER_ID LIKE 'test1'
	AND T.FLAG LIKE 'star'
	AND G.TAG_FLAG LIKE '재료'
	GROUP BY  G.TAG_NAME
	ORDER BY ingreAvg DESC 
	LIMIT 8) A
	ORDER BY ingreCnt DESC;
 	</select>
 	<select id="chartBrand" resultType="java.util.HashMap">
 	SELECT I.BRAND AS "brand", SUM(T.QUANTITY) AS 'brandSum'
	FROM ITEM AS I, TASTE AS T
	WHERE I.ITEM_SEQ = T.ITEM_SEQ
       AND T.MEMBER_ID LIKE 'test1'
       AND T.FLAG LIKE 'buy'
	GROUP BY I.BRAND
	ORDER BY brandSum desc
	LIMIT 5;
 	</select>
 	<select id="chartTaste" resultType="java.util.HashMap">
 	</select>
 	<select id="chartEmotion" resultType="java.util.HashMap">
 	</select>
 	<select id="chartMenu" resultType="java.util.HashMap">
 	SELECT I.CATEGORY AS "menu", AVG(T.GRADE) AS 'menuAvg', COUNT(T.GRADE) AS 'menuCnt'
	FROM ITEM AS I, TASTE AS T
	WHERE I.ITEM_SEQ = T.ITEM_SEQ
    AND T.MEMBER_ID LIKE 'test1'
    AND T.FLAG LIKE 'star'
	GROUP BY I.CATEGORY;
 	</select>
 	<insert id="postCart">
 	INSERT INTO TASTE
	(Flag, MEMBER_ID, ITEM_SEQ,Quantity)
	VALUES
	('cart', #{id}, #{itemSeq}, #{quantity});
 	</insert>
 	<delete id="deleteCart" parameterType="map">
 	DELETE FROM TASTE 
  	WHERE FLAG LIKE "cart" 
  	  <choose>
            <when test="delList.size != 0">
                AND TASTE_SEQ IN 
                <foreach collection="delList" item="item" index="index" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </when>
        </choose>
 	</delete>
 	<select id="listCart" resultMap="tmap">
 	SELECT T.*,I.*, IMG.*
	FROM ITEM I
	JOIN TASTE T
	ON T.ITEM_SEQ LIKE I.ITEM_SEQ
	JOIN IMAGE IMG
	ON I.ITEM_SEQ LIKE IMG.ITEM_SEQ
	WHERE T.FLAG LIKE #{flag}
	AND T.MEMBER_ID LIKE #{id}
	ORDER BY T.TASTE_DATE DESC, T.TASTE_TIME DESC;
 	</select>
  </mapper>

  